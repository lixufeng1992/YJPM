<!DOCTYPE html>
<html>
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>亿建工程管理系统</title>
  <include file="./Tpl/Part/css.html" />

</head>
<body>
<include file="./Tpl/Part/header.html" />
<include file="./Tpl/Part/left.html" />
<div id="right">
    <nav class="navbar navbar-default" role="navigation" id="bodynav">
      <div class="container-fluid">
       <div class="navbar-header navbar-brand">设备查询</div>
        <ul class="nav navbar-nav navbar-right">
          <li><a href="{:U('')}" class="active">设备查询</a></li>
        </ul>
      </div>
    </nav>
    <div class="panel-group">
        <div class="panel panel-default">
            <div class="panel-body">
                <div class="page-header">
					<div class="col-md-4">
						<h4>设备查询</h4>
					</div>
					<div class="col-md-4">
						<h4 id="project_name"></h4>
					</div>

					<div style="clear:both"></div>
				</div>
				<div class="page-header">
					<form class="form-horizontal" id="query_condition">
						<div class="form-group">
							<label class="col-md-2 control-label">所属项目</label>
							<div class="col-md-2">
								<input class="form-control project_select" type="text" id="belong_name" readonly>
								<input type="hidden" id="belong_id">
							</div>
							<label class="col-md-2 control-label">所在项目</label>
							<div class="col-md-2">
								<input class="form-control project_select" type="text" id="location_name" readonly>
								<input type="hidden" id="location_id">
							</div>
							<label class="col-md-2 control-label">往来单位</label>
							<div class="col-md-2">
								<input class="form-control" type="text" id="enterprise_name" readonly data-toggle="modal" data-target="#enterpriseModal">
								<input type="hidden" id="enterprise_id">
							</div>
						</div>
						<div class="form-group">
							<label class="col-md-2 control-label">设备编码</label>
							<div class="col-md-2">
								<input class="form-control" type="text" id="device_code">
								<input type="hidden" id="belong_id">
							</div>
							<label class="col-md-2 control-label">设备名称</label>
							<div class="col-md-2">
								<input class="form-control" type="text" id="device_name">
							</div>
							<label class="col-md-2 control-label">经营状态</label>
							<div class="col-md-2">
								<input class="form-control" type="text" id="state">
							</div>
						</div>
						<div class="form-group">
							<div class="col-md-offset-10 col-md-1">
								<button type="button" id="search_btn" class="btn btn-primary">查询</button>
							</div>
							<div class="col-md-1">
								<button type="button" class="btn btn-default" id="reset_btn">清空</button>
							</div>
						</div>
					</form>
				</div>
                <table class="table">
					<thead>
							<th>设备编码</th>
							<th>设备名称</th>
							<th>所属项目</th>
							<th>所在项目</th>
							<th>往来单位</th>
							<th>经营状态</th>
							<th>领用日期</th>
					</thead>
					<tbody>
						<tr data-id="1" data-belong="24" data-location="25">
							<td>222</td>
							<td>设31备1</td>
							<td>所属项目1</td>
							<td>所在项目1</td>
							<td></td>
							<td>状态1</td>
							<td>2015-3-3</td>
						</tr>
						<tr data-id="2" data-belong="24" data-enterprise="1">
							<td>1231231</td>
							<td>设备1</td>
							<td>所属项目1</td>
							<td></td>
							<td>往来单位1</td>
							<td>状AA2</td>
							<td>2015-3-3</td>
						</tr>

					</tbody>
				</table>
            </div>
        </div>
    </div>
</div>
<div class="ui sidebar left overlay panel panel-default">
	<div class="page-header">
		<h4 style="padding-left:15px">项目与机构列表</h4>
	</div>
	<div class="panel-body">
		<ul class="list-group sidebar-tree" id="project_tree">
			<volist name="resourceRowArray" id="vo_level_1">
			<if condition="($vo_level_1.resource_level eq 1) AND ($vo_level_1.resource_type eq 1)">
			<li class="list-group-item list-group-item-info">
				<if condition="$vo_level_1.resource_haschildren eq 1">
				<span class="glyphicon glyphicon-minus-sign"></span>
				</if>
				<a href="#" class="tree-item">公司机构或公司总库</a>
			</li>
			<if condition="$vo_level_1.resource_haschildren eq 1">
			<li class="list-group-item collapse in">
				<ul class="list-group">
					<volist name="resourceRowArray" id="vo_level_2">				
					<if condition="$vo_level_2.resource_level eq 2">
					<eq name="vo_level_2.resource_father_id" value="$vo_level_1.resource_id">
						<li class="list-group-item" data-level="{$vo_level_2.resource_level}" data-id="{$vo_level_2.resource_id}">
						<if condition="$vo_level_2.resource_haschildren eq 1">
						<span class="glyphicon glyphicon-plus-sign"></span>
						</if>
						<a href="{$vo_level_2.resource_id}" class="tree-item" >{$vo_level_2.resource_name}</a>
						</li>
						<if condition="$vo_level_2.resource_haschildren eq 1">
						<li class="list-group-item collapse in">
							<ul class="list-group">
								<volist name="resourceRowArray" id="vo_level_3">
								<if condition="$vo_level_3.resource_level eq 3">
								<eq name="vo_level_3.resource_father_id" value="$vo_level_2.resource_id">
									<li class="list-group-item">
										<a href="{$vo_level_3.resource_id}" class="tree-item" >{$vo_level_3.resource_name}</a>
									</li>								
								</eq>
								</if>
							</volist>
							</ul>
						</li>
						</if>
					</eq>
					</if>					
					</volist>
				</ul>
			</li>
			</if>
			</if>
		</volist>
		
<volist name="resourceRowArray" id="vo_level_1">
<if condition="($vo_level_1.resource_level eq 1) AND ($vo_level_1.resource_type eq 2)">
			<li class="list-group-item list-group-item-info">				
				<if condition="$vo_level_1.resource_haschildren eq 1">
				<span class="glyphicon glyphicon-minus-sign"></span>
				</if>
				<a href="#" class="tree-item">项目</a>
			</li>
			<if condition="$vo_level_1.resource_haschildren eq 1">
			<li class="list-group-item collapse in">
				<ul class="list-group">
					<volist name="resourceRowArray" id="vo_level_2">				
					<if condition="$vo_level_2.resource_level eq 2">
					<eq name="vo_level_2.resource_father_id" value="$vo_level_1.resource_id">
						<li class="list-group-item">
						<if condition="$vo_level_2.resource_haschildren eq 1">
						<span class="glyphicon glyphicon-plus-sign"></span>
						</if>
						<a href="{$vo_level_2.resource_id}" class="tree-item" >{$vo_level_2.resource_name}</a>
						</li>
						<if condition="$vo_level_2.resource_haschildren eq 1">
						<li class="list-group-item collapse in">
							<ul class="list-group">
								<volist name="resourceRowArray" id="vo_level_3">
								<if condition="$vo_level_3.resource_level eq 3">
								<eq name="vo_level_3.resource_father_id" value="$vo_level_2.resource_id">
									<li class="list-group-item">
									<a href="{$vo_level_3.resource_id}" class="tree-item" >{$vo_level_3.resource_name}</a>
									</li>								
								</eq>
								</if>
							</volist>
							</ul>
						</li>
						</if>
					</eq>
					</if>					
					</volist>
				</ul>
			</li>
			</if>			
			</if>
</volist>
		</ul>
	</div>
</div>
<div class="modal fade" id="enterpriseModal" tabindex="-1" role="dialog" aria-labelledby="enterpriseModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title" id="enterpriseModalLabel">往来单位选择</h4>
            <div class="container-fluid" style="margin-top:15px">
                <div class="row">
                    <div class="col-md-3">
                        <div class="radio">
                            <label>
                                <input type="radio" name="classify" value="is_all" checked>全部
                            </label>
                        </div>
                        <div class="radio">
                            <label>
                                <input type="radio" name="classify" value="is_1part">甲方
                            </label>
                        </div>
                    </div> 
                    <div class="col-md-3">
                        <div class="radio">
                            <label>
                                <input type="radio" name="classify" value="is_divideman">分包商
                            </label>
                        </div>
                        <div class="radio">
                            <label>
                                <input type="radio" name="classify" value="is_materialman">材料商
                            </label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="radio">
                            <label>
                                <input type="radio" name="classify" value="is_machineman">机械商
                            </label>
                        </div>
                        <div class="radio">
                            <label>
                                <input type="radio" name="classify" value="is_transman">内部单位
                            </label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="radio">
                            <label>
                                <input type="radio" name="classify" value="is_client">客户
                            </label>
                        </div>
                        <div class="radio">
                            <label>
                                <input type="radio" name="classify" value="is_otherpart">其他单位
                            </label>
                        </div>
                    </div>   	
                </div>
                <div class="row" style="margin-top:15px">
                    <div class="col-md-4">客户名称</div>
                    <div class="col-md-2">联系人</div>
                    <div class="col-md-3">联系电话</div>
                    <div class="col-md-3">地址</div>
                </div>
            </div>
      </div>
      <div class="modal-body"  style="max-height:500px;overflow:auto" >
        <div class="list-group" id="enterprises">
            <volist name="enterpriseRowArray" id="vo">
                <a href="{$vo.enterpriseid}" class="list-group-item 
                <if condition="$vo['is_1part'] eq 1">is_1part <else/> </if>
                <if condition="$vo['is_divideman'] eq 1">is_divideman <else/> </if>
                <if condition="$vo['is_materialman'] eq 1">is_materialman <else/> </if>
                <if condition="$vo['is_machineman'] eq 1">is_machineman <else/> </if>
                <if condition="$vo['is_transman'] eq 1">is_transman <else/> </if>
                <if condition="$vo['is_client'] eq 1">is_client <else/> </if>
                <if condition="$vo['is_otherpart'] eq 1">is_otherpart <else/> </if>
                ">
                <div class="row">
                    <div class="col-md-4">{$vo.name}</div>
                    <div class="col-md-2">{$vo.contact_person}</div>
                    <div class="col-md-3">{$vo.phone_number}</div>
                    <div class="col-md-3">{$vo.address}</div>
                </div>
                </a>
            </volist>
        </div>
      </div>
      <div class="modal-footer">
		<button type="button" class="btn btn-primary" id="chooseEnterprise">确定</button>
        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
      </div>
    </div>
  </div>
</div>

<include file="./Tpl/Part/script.html" />
<script type="text/javascript">
$().ready(function(){
	$("#query_condition").on("change","input",function(){
		var belong = $("#belong_id").val();
		var location = $("#location_id").val();
		var enterprise = $("#enterprise_id").val();
		var code = $("#device_code").val();
		var name = $("#device_name").val();
		var state = $("#state").val();
		var resultset = $("tbody tr");
		if (belong){
			resultset = resultset.filter("tr[data-belong='"+belong+"']");
		}
		if (location){
			resultset = resultset.filter("tr[data-location='"+location+"']");
		}
		if (enterprise){
			resultset = resultset.filter("tr[data-enterprise='"+enterprise+"']");
		}
		var rs = resultset;
		resultset.each(function(){
			if (code){
				console.info($(this).children().eq(0).text().indexOf(code))
				if ($(this).children().eq(0).text().indexOf(code)<0){
					rs = rs.not($(this));
				}
			}
			if (name){
				if ($(this).children().eq(1).text().indexOf(name)<0){
					rs = rs.not($(this));
				}
			}
			if (state){
				if ($(this).children().eq(5).text().indexOf(state)<0){
					rs = rs.not($(this));
				}
			}
		});
		resultset = rs;
		$("tbody tr").hide();
		resultset.show();
		
	});
	$("#search_btn").click(function(){
		$("#belong_id").change();
	})
	$("#reset_btn").click(function(){
		$("#query_condition input").val("");
		$("tr").show();
	});
	$('#enterpriseModal').on('show.bs.modal', function (e) {
		$("#enterpriseModal").removeData("enterprise");
		$("#enterpriseModal").data("dataTarget",e.relatedTarget);
		$("#enterprises a").removeClass("active");
	});
	$("#chooseEnterprise").click(function(){
		var data = $("#enterpriseModal").data("enterprise");
		if (data){
			$($("#enterpriseModal").data("dataTarget")).val(data.name);
			$($("#enterpriseModal").data("dataTarget")).next().val(data.id);
			$($("#enterpriseModal").data("dataTarget")).next().change();
			$('#enterpriseModal').modal('hide');
		}
	});
 	$("#enterprises a").click(function(e){
		e.preventDefault();
		var data = $("#enterpriseModal").data("lastActive");
		if (data){
			data.removeClass("active");
		}
		$(this).addClass("active");
		$("#enterpriseModal").data("lastActive",$(this));
		$("#enterpriseModal").data("enterprise",{id : $(this).attr("href") , name : $(this).children().first().children().first().text()});
		return false;
	});
	$("input[name='classify']").change(function(){
		var c = $("input[name='classify']:checked").val();
		if (c=="is_all"){
			$("#enterprises a").show();
		}else{
			$("#enterprises a").hide();
			$("."+c).show();
		}
	});
	$(".project_select").click(function(){
		$(".ui.sidebar").data("whichone",$(this));
		$(".ui.sidebar").sidebar('show');
	});
	$("#project_tree").on("click","a",function(e){
		e.preventDefault();
		if($(this).attr("href")!="#"){
			$(".ui.sidebar").data("whichone").val($(this).text().trim());
			$(".ui.sidebar").data("whichone").next().val($(this).attr("href").trim());
			$(".ui.sidebar").data("whichone").next().change();
			$(".ui.sidebar").sidebar('hide');
		}
	})
});
</script>
</body>
</html>
